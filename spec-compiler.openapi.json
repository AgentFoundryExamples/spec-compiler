{
  "openapi": "3.1.0",
  "info": {
    "title": "Spec Compiler Service",
    "description": "FastAPI service for compiling specifications with LLM integrations",
    "version": "0.1.0"
  },
  "paths": {
    "/health": {
      "get": {
        "tags": [
          "health"
        ],
        "summary": "Health Check",
        "description": "Health check endpoint.\n\nReturns a simple status indicator for container orchestration systems.\n\nReturns:\n    Dictionary with status \"ok\"",
        "operationId": "health_check_health_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "additionalProperties": {
                    "type": "string"
                  },
                  "type": "object",
                  "title": "Response Health Check Health Get"
                }
              }
            }
          }
        }
      }
    },
    "/debug/status": {
      "post": {
        "tags": [
          "health"
        ],
        "summary": "Debug Publish Status",
        "description": "Debug endpoint to test status message publishing.\n\nOnly available in development environments for safety.\nPublishes a sample status message to verify Pub/Sub configuration.\n\nReturns:\n    Dictionary with status and message\n\nRaises:\n    HTTPException: 403 if not in development environment\n    HTTPException: 500 if publisher configuration is invalid\n    HTTPException: 503 if publish fails",
        "operationId": "debug_publish_status_debug_status_post",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "additionalProperties": {
                    "anyOf": [
                      {
                        "type": "string"
                      },
                      {
                        "type": "integer"
                      }
                    ]
                  },
                  "type": "object",
                  "title": "Response Debug Publish Status Debug Status Post"
                }
              }
            }
          }
        }
      }
    },
    "/compile-spec": {
      "post": {
        "tags": [
          "compile"
        ],
        "summary": "Compile Spec",
        "description": "Compile a specification with LLM integration (async 202 workflow).\n\nExecutes a staged pipeline for processing specifications:\n1. Validate request and check size limits\n2. Publish in-progress status\n3. Enqueue background task for async processing\n4. Return HTTP 202 Accepted immediately\n\nBackground task executes:\n3. Mint GitHub access token\n4. Fetch repository context\n5. Create LLM client\n6. Call LLM with latency tracking\n7. Send compiled spec downstream\n8. Publish succeeded status\n\nArgs:\n    request: FastAPI request object (for accessing request_id and body)\n    background_tasks: FastAPI background tasks manager\n    idempotency_key: Optional idempotency key for client-side deduplication\n\nReturns:\n    CompileResponse with request tracking information\n\nRaises:\n    HTTPException: Various status codes based on validation failure",
        "operationId": "compile_spec_compile_spec_post",
        "parameters": [
          {
            "name": "Idempotency-Key",
            "in": "header",
            "required": false,
            "schema": {
              "anyOf": [
                {
                  "type": "string"
                },
                {
                  "type": "null"
                }
              ],
              "title": "Idempotency-Key"
            }
          }
        ],
        "responses": {
          "202": {
            "description": "Request accepted for processing",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CompileResponse"
                },
                "example": {
                  "request_id": "550e8400-e29b-41d4-a716-446655440000",
                  "plan_id": "plan-abc123",
                  "spec_index": 0,
                  "status": "accepted",
                  "message": "Request accepted for processing"
                }
              }
            }
          },
          "413": {
            "description": "Request body too large",
            "content": {
              "application/json": {
                "example": {
                  "detail": "Request body exceeds maximum size limit of 10485760 bytes"
                }
              }
            }
          },
          "422": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "example": {
                  "detail": [
                    {
                      "loc": [
                        "body",
                        "spec",
                        "purpose"
                      ],
                      "msg": "Field cannot be empty or whitespace-only",
                      "type": "value_error"
                    }
                  ]
                }
              }
            }
          }
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CompileRequest"
              },
              "example": {
                "plan_id": "plan-abc123",
                "spec_index": 0,
                "spec": {
                  "purpose": "Add user authentication system",
                  "vision": "Users can securely log in and manage their accounts",
                  "must": [
                    "Support OAuth2 authentication",
                    "Implement session management",
                    "Hash passwords with bcrypt"
                  ],
                  "dont": [
                    "Store passwords in plain text",
                    "Use deprecated authentication methods"
                  ],
                  "nice": [
                    "Support two-factor authentication",
                    "Provide password recovery flow"
                  ],
                  "assumptions": [
                    "HTTPS is enabled",
                    "Database supports user tables"
                  ]
                },
                "github_owner": "my-org",
                "github_repo": "my-project"
              }
            }
          }
        }
      }
    },
    "/version": {
      "get": {
        "tags": [
          "info"
        ],
        "summary": "Version Info",
        "description": "Return application version information.\n\nReturns git SHA if available from environment, otherwise returns\nthe configured APP_VERSION.",
        "operationId": "version_info_version_get",
        "responses": {
          "200": {
            "description": "Successful Response",
            "content": {
              "application/json": {
                "schema": {
                  "additionalProperties": {
                    "type": "string"
                  },
                  "type": "object",
                  "title": "Response Version Info Version Get"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "CompileResponse": {
        "properties": {
          "request_id": {
            "type": "string",
            "title": "Request Id",
            "description": "Unique request identifier"
          },
          "plan_id": {
            "type": "string",
            "title": "Plan Id",
            "description": "Plan identifier"
          },
          "spec_index": {
            "type": "integer",
            "title": "Spec Index",
            "description": "Specification index"
          },
          "status": {
            "type": "string",
            "enum": [
              "accepted",
              "failed"
            ],
            "title": "Status",
            "description": "Processing status"
          },
          "message": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "type": "null"
              }
            ],
            "title": "Message",
            "description": "Optional status message"
          }
        },
        "type": "object",
        "required": [
          "request_id",
          "plan_id",
          "spec_index",
          "status"
        ],
        "title": "CompileResponse",
        "description": "Response model for the compile API endpoint.\n\nThis represents the external API contract for the compile response.\n\nAttributes:\n    request_id: Unique identifier for this request (UUID format)\n    plan_id: Plan identifier echoed from the request\n    spec_index: Specification index echoed from the request\n    status: Processing status (accepted or failed)\n    message: Optional message providing additional context"
      },
      "CompileSpec": {
        "description": "Specification data model containing the structured spec contract.\n\nThis model defines the six required fields that make up a specification,\nproviding clear documentation and validation for the compile endpoint.\n\nAttributes:\n    purpose: A concise statement of what this spec aims to achieve\n    vision: The desired end state or outcome after implementation\n    must: List of mandatory requirements that must be satisfied\n    dont: List of constraints or things that must be avoided\n    nice: List of optional enhancements that would be beneficial but not required\n    assumptions: List of assumptions or preconditions for this spec",
        "properties": {
          "purpose": {
            "description": "A concise statement of what this spec aims to achieve",
            "minLength": 1,
            "title": "Purpose",
            "type": "string"
          },
          "vision": {
            "description": "The desired end state or outcome after implementation",
            "minLength": 1,
            "title": "Vision",
            "type": "string"
          },
          "must": {
            "description": "List of mandatory requirements that must be satisfied",
            "items": {
              "type": "string"
            },
            "title": "Must",
            "type": "array"
          },
          "dont": {
            "description": "List of constraints or things that must be avoided",
            "items": {
              "type": "string"
            },
            "title": "Dont",
            "type": "array"
          },
          "nice": {
            "description": "List of optional enhancements that would be beneficial but not required",
            "items": {
              "type": "string"
            },
            "title": "Nice",
            "type": "array"
          },
          "assumptions": {
            "description": "List of assumptions or preconditions for this spec",
            "items": {
              "type": "string"
            },
            "title": "Assumptions",
            "type": "array"
          }
        },
        "required": [
          "purpose",
          "vision",
          "must",
          "dont",
          "nice",
          "assumptions"
        ],
        "title": "CompileSpec",
        "type": "object"
      },
      "CompileRequest": {
        "description": "Request model for the compile API endpoint.\n\nThis represents the external API contract for compiling a specification.\nAll fields are validated to ensure data integrity before processing.\n\nAttributes:\n    plan_id: Non-empty identifier for the plan\n    spec_index: Zero-based index of the specification (must be >= 0)\n    spec: Structured specification containing purpose, vision, requirements, and constraints\n    github_owner: Non-empty GitHub repository owner (user or organization)\n    github_repo: Non-empty GitHub repository name",
        "properties": {
          "plan_id": {
            "description": "Plan identifier",
            "minLength": 1,
            "title": "Plan Id",
            "type": "string"
          },
          "spec_index": {
            "description": "Specification index (must be >= 0)",
            "minimum": 0,
            "title": "Spec Index",
            "type": "integer"
          },
          "spec": {
            "$ref": "#/components/schemas/CompileSpec",
            "description": "Structured specification containing purpose, vision, requirements, and constraints"
          },
          "github_owner": {
            "description": "GitHub repository owner",
            "minLength": 1,
            "title": "Github Owner",
            "type": "string"
          },
          "github_repo": {
            "description": "GitHub repository name",
            "minLength": 1,
            "title": "Github Repo",
            "type": "string"
          }
        },
        "required": [
          "plan_id",
          "spec_index",
          "spec",
          "github_owner",
          "github_repo"
        ],
        "title": "CompileRequest",
        "type": "object"
      }
    }
  }
}